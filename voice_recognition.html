<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>ずんだもんとお話</title>
    <style>
      .dialogue {
        margin-bottom: 1rem;
      }
    </style>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js" crossorigin="anonymous"></script>

  </head>
  <body>
    <main>
      <h2>ずんだもんとお話</h2>
      <button type="button" class="start">音声認識開始</button>
      <button type="button" class="stop">終了</button>
      <div class="output" style="display: none;"></div>
      <h2> チャット </h2>
      <div class="dialogue-container"></div>
      
      <button type="button" class="play-last">音声リプレイ</button>
      

    </main>
    <script>
      async function sendTextToServer(text) {
        await fetch('http://localhost:5000/send_text', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: 'text=' + encodeURIComponent(text)
        });
      }


      const recognition = new webkitSpeechRecognition(); // prefix 必要 SpeechRecognition
      recognition.lang = "ja";
      recognition.continuous = true;
      recognition.onresult = ({ results }) => {
        const output = document.querySelector(".output");
        output.textContent = results[0][0].transcript;
      };

      const startButton = document.querySelector(".start");
      startButton.addEventListener("click", () => {
        recognition.start();
      });

      const stopButton = document.querySelector(".stop");
      stopButton.addEventListener("click", () => {
        recognition.stop();
      });

      recognition.onend = () => {
        const output = document.querySelector(".output");
        sendTextToServer(output.textContent);
      };

      
//履歴表示
async function displayDialogueHistory(history) {
  const dialogueContainer = document.querySelector('.dialogue-container');
  dialogueContainer.innerHTML = '';

  for (let i = 0; i < history.length; i++) {
    const role = i % 2 === 0 ? "自分" : "ずんだもん";
    const dialogue = document.createElement('div');
    dialogue.classList.add('dialogue');
    dialogue.textContent = `${role}: ${history[i]}`;
    dialogueContainer.appendChild(dialogue);
  }
}

const socket = io.connect('http://localhost:5000');
      socket.on('dialogue_history', async (history) => {
      console.log('Received dialogue_history event:', history);
      await displayDialogueHistory(history);
      });





//声の再生(Web版)
      async function playLastAudio() {
        try {
          const audio = new Audio("http://localhost:5000/output.wav");
          await audio.play();
        } catch (error) {
          console.error("Error playing audio:", error);
        }
      }

      const playLastButton = document.querySelector(".play-last");
      playLastButton.addEventListener("click", () => {
        playLastAudio();
      });

      
    </script>
  </body>
</html>